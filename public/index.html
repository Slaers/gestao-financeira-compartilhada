<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu App de Finanças</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Adicionada CDN do Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class', // Habilita o modo escuro via classe 'dark' no HTML
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            DEFAULT: '#4F46E5', // Indigo-600
                            hover: '#4338CA', // Indigo-700
                            light: '#6366F1', // Indigo-500
                        },
                        secondary: '#1F2937', // Gray-800
                        accent: '#10B981', // Emerald-500
                        danger: '#EF4444', // Red-500
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
          .no-scrollbar::-webkit-scrollbar {
            display: none;
          }
          .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
          }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white font-sans antialiased transition-colors duration-300">
    <div id="app-container" class="flex flex-col min-h-screen">
        <!-- Barra de navegação/Sidebar será inserida aqui dinamicamente -->
        <nav id="navbar-container" class="sticky top-0 z-50"></nav>

        <!-- O conteúdo principal da página dinâmica será carregado aqui -->
        <main id="app-root" class="flex-grow container mx-auto px-4 py-8">
            <!-- Conteúdo inicial ou loader -->
            <div id="initial-loader" class="flex justify-center items-center h-full">
                <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-primary-DEFAULT" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </main>

        <footer class="bg-gray-200 dark:bg-gray-800 text-center p-4 text-sm text-gray-600 dark:text-gray-400">
            © 2024 Meu App de Finanças. Todos os direitos reservados.
            <p class="text-xs">User ID: <span id="user-id-display">Não conectado</span></p>
        </footer>
    </div>

    <!-- Modals Globais -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-75 hidden z-40 transition-opacity duration-300"></div>
    <div id="modal-container" class="fixed inset-0 flex items-center justify-center hidden z-50 p-4">
        <!-- Conteúdo do Modal será injetado aqui -->
    </div>


    <!-- Templates HTML para as páginas (serão carregadas pelo router.js) -->
    <template id="login-template">
        <div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)] sm:min-h-0 sm:py-12">
            <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-secondary rounded-xl shadow-2xl">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-auto text-primary-DEFAULT" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                    </svg>
                    <h2 class="mt-6 text-3xl font-bold tracking-tight text-gray-900 dark:text-white">
                        Acesse sua conta
                    </h2>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                        Ou <button id="go-to-register" class="font-medium text-primary-DEFAULT hover:text-primary-hover">crie uma nova conta</button>
                    </p>
                </div>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                        <input id="login-email" name="email" type="email" autocomplete="email" required
                               class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Senha</label>
                        <input id="login-password" name="password" type="password" autocomplete="current-password" required
                               class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm text-gray-900 dark:text-white">
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="text-sm">
                            <a href="#" id="forgot-password-link" class="font-medium text-primary-DEFAULT hover:text-primary-hover">Esqueceu sua senha?</a>
                        </div>
                    </div>
                    <div>
                        <button type="submit"
                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-DEFAULT hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-DEFAULT transition-transform transform hover:scale-105">
                            Entrar
                        </button>
                    </div>
                </form>
                 <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center" aria-hidden="true">
                        <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white dark:bg-secondary text-gray-500 dark:text-gray-400">Ou continue com</span>
                    </div>
                </div>
                <div>
                    <button id="login-google" type="button" class="w-full inline-flex justify-center py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 transition-transform transform hover:scale-105">
                        <span class="sr-only">Entrar com Google</span>
                        <svg class="w-5 h-5" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 0C4.477 0 0 4.477 0 10c0 4.418 2.865 8.146 6.839 9.491.5.092.682-.217.682-.483 0-.237-.009-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0110 4.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.026 2.747-1.026.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.338 4.695-4.566 4.942.359.308.678.92.678 1.856 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0020 10c0-5.523-4.477-10-10-10z" clip-rule="evenodd" />
                        </svg>
                         <span class="ml-2">Google</span>
                    </button>
                </div>

                <p id="login-error" class="text-sm text-danger hidden text-center"></p>
            </div>
        </div>
    </template>

    <template id="register-template">
        <div class="flex flex-col items-center justify-center min-h-[calc(100vh-200px)] sm:min-h-0 sm:py-12">
            <div class="w-full max-w-md p-8 space-y-6 bg-white dark:bg-secondary rounded-xl shadow-2xl">
                <div class="text-center">
                     <svg class="mx-auto h-12 w-auto text-primary-DEFAULT" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-2.25-4.125a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zM4 19.235v-.11a6.375 6.375 0 0112.75 0v.109A12.318 12.318 0 0110.374 21c-2.331 0-4.512-.645-6.374-1.766z" />
                    </svg>
                    <h2 class="mt-6 text-3xl font-bold tracking-tight text-gray-900 dark:text-white">
                        Crie sua conta
                    </h2>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                        Já tem uma conta? <button id="go-to-login" class="font-medium text-primary-DEFAULT hover:text-primary-hover">Faça login</button>
                    </p>
                </div>
                <form id="register-form" class="space-y-6">
                    <div>
                        <label for="register-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nome Completo</label>
                        <input id="register-name" name="name" type="text" autocomplete="name" required
                               class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm">
                    </div>
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                        <input id="register-email" name="email" type="email" autocomplete="email" required
                               class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Senha</label>
                        <input id="register-password" name="password" type="password" autocomplete="new-password" required
                               class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm">
                    </div>
                     <div>
                        <label for="register-confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Confirmar Senha</label>
                        <input id="register-confirm-password" name="confirm-password" type="password" autocomplete="new-password" required
                               class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm">
                    </div>
                    <div>
                        <button type="submit"
                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-DEFAULT hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-DEFAULT transition-transform transform hover:scale-105">
                            Criar conta
                        </button>
                    </div>
                </form>
                <p id="register-error" class="text-sm text-danger hidden text-center"></p>
            </div>
        </div>
    </template>

    <template id="dashboard-template">
        <div class="p-4 md:p-8">
            <h1 class="text-3xl md:text-4xl font-bold mb-6 text-gray-800 dark:text-white">Seu Painel Financeiro</h1>
            <p class="text-lg text-gray-600 dark:text-gray-300 mb-8">Bem-vindo(a) de volta, <span id="user-name-dashboard" class="font-semibold">Usuário</span>!</p>

            <!-- Resumo Financeiro -->
            <section id="summary-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <!-- Card de Receitas -->
                <div class="bg-gradient-to-br from-green-400 to-emerald-600 dark:from-green-500 dark:to-emerald-700 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform duration-300">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Receitas do Mês</h3>
                        <svg class="w-8 h-8 opacity-75" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 11.219 12.768 11 12 11c-.768 0-1.536.219-2.121.727L9 12.818V15m2.59-2.59A1.5 1.5 0 0011.25 12h-1.5a1.5 1.5 0 00-1.09 2.59L9 15m0-2.182l-.879-.659a1.5 1.5 0 00-2.121 0c-1.172.879-1.172 2.303 0 3.182C6.464 16.781 7.232 17 8 17c.768 0 1.536-.219 2.121-.727L11.25 15m0-2.182l.879-.659a1.5 1.5 0 002.121 0c1.172.879 1.172 2.303 0 3.182C15.536 16.781 14.768 17 14 17c-.768 0-1.536-.219-2.121-.727L10.75 15m6.75-6H6.75C6.336 9 6 8.664 6 8.25V6.75C6 6.336 6.336 6 6.75 6H17.25c.414 0 .75.336.75.75v1.5c0 .414-.336.75-.75.75z" />
                        </svg>
                    </div>
                    <p id="dashboard-total-receitas" class="text-4xl font-extrabold">R$ 0,00</p>
                </div>
                <!-- Card de Despesas -->
                <div class="bg-gradient-to-br from-red-400 to-rose-600 dark:from-red-500 dark:to-rose-700 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform duration-300">
                     <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Despesas do Mês</h3>
                        <svg class="w-8 h-8 opacity-75" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h6m3-3.75l-3 3m0 0l-3-3m3 3V1.5m6 5.25h.008v.008H18V1.5m0 9.75h.008v.008H18V11.25m-6 0h.008v.008H12V11.25m0 0V6.75m0 4.5H9.75m8.25 0H18M9 21.75H4.5c-.621 0-1.125-.504-1.125-1.125V5.625c0-.621.504-1.125 1.125-1.125H9M15 4.5V2.25m0 2.25H9m5.25 0h2.25m0 0V2.25m0 2.25c0 .621.504 1.125 1.125 1.125h2.25c.621 0 1.125-.504 1.125-1.125V2.25A2.25 2.25 0 0018.75 0H5.25A2.25 2.25 0 003 2.25v16.5A2.25 2.25 0 005.25 21H9" />
                        </svg>
                    </div>
                    <p id="dashboard-total-despesas" class="text-4xl font-extrabold">R$ 0,00</p>
                </div>
                <!-- Card de Saldo -->
                 <div class="bg-gradient-to-br from-blue-400 to-indigo-600 dark:from-blue-500 dark:to-indigo-700 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform duration-300">
                     <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Saldo Atual</h3>
                        <svg class="w-8 h-8 opacity-75" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.105 0-2 .895-2 2s.895 2 2 2 2-.895 2-2-.895-2-2-2zm0 5c-2.761 0-5 2.239-5 5h10c0-2.761-2.239-5-5-5z" />
                        </svg>
                    </div>
                    <p id="dashboard-saldo-atual" class="text-4xl font-extrabold">R$ 0,00</p>
                </div>
                <!-- Card de Investimentos -->
                <div class="bg-gradient-to-br from-purple-400 to-fuchsia-600 dark:from-purple-500 dark:to-fuchsia-700 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform duration-300">
                     <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold">Total Investido</h3>
                        <svg class="w-8 h-8 opacity-75" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
                        </svg>
                    </div>
                    <p id="dashboard-total-investido" class="text-4xl font-extrabold">R$ 0,00</p>
                </div>
            </section>

            <!-- Gráficos -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                <div class="bg-white dark:bg-secondary p-6 rounded-xl shadow-xl">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Despesas por Categoria</h3>
                    <div class="h-80"><canvas id="expenses-pie-chart"></canvas></div>
                </div>
                <div class="bg-white dark:bg-secondary p-6 rounded-xl shadow-xl">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Receitas vs Despesas (Últimos 6 meses)</h3>
                     <div class="h-80"><canvas id="income-expenses-bar-chart"></canvas></div>
                </div>
            </section>

             <!-- Lançamentos Recentes -->
            <section>
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-semibold text-gray-800 dark:text-white">Lançamentos Recentes</h3>
                    <button id="view-all-lancamentos"
                            class="px-4 py-2 bg-primary-DEFAULT text-white rounded-lg hover:bg-primary-hover transition-colors text-sm font-medium shadow-md">
                        Ver Todos
                    </button>
                </div>
                <div id="recent-lancamentos-list" class="bg-white dark:bg-secondary rounded-xl shadow-xl overflow-hidden">
                    <!-- Itens da lista serão injetados aqui -->
                    <p class="p-6 text-gray-500 dark:text-gray-400">Nenhum lançamento recente.</p>
                </div>
            </section>
        </div>
    </template>

    <template id="navbar-template-logged-out">
        <div class="bg-white dark:bg-secondary shadow-md">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <a href="#/" class="flex-shrink-0 flex items-center text-primary-DEFAULT dark:text-primary-light font-bold text-xl">
                            <svg class="h-8 w-auto mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                            </svg>
                            FinançasApp
                        </a>
                    </div>
                    <div class="flex items-center">
                         <button id="theme-toggle-button-navbar" class="p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary-DEFAULT">
                            <svg id="theme-icon-light-navbar" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-15.66l-.707.707M4.04 19.96l-.707.707M21 12h-1M4 12H3m15.66 8.66l-.707-.707M4.04 4.04l-.707-.707"/></svg>
                            <svg id="theme-icon-dark-navbar" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        </button>
                        <a href="#/login" class="ml-4 px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-DEFAULT hover:bg-primary-hover">
                            Login
                        </a>
                        <a href="#/register" class="ml-2 px-4 py-2 border border-primary-DEFAULT rounded-md shadow-sm text-sm font-medium text-primary-DEFAULT hover:bg-primary-DEFAULT hover:text-white dark:text-primary-light dark:hover:bg-primary-light dark:hover:text-gray-900">
                            Cadastrar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="navbar-template-logged-in">
        <div class="bg-white dark:bg-secondary shadow-lg sticky top-0 z-50">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <!-- Logo e Nome do App -->
                    <a href="#/" class="flex items-center text-primary-DEFAULT dark:text-primary-light font-bold text-2xl">
                        <svg class="h-10 w-auto mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                           <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                        FinançasApp
                    </a>

                    <!-- Navegação Desktop -->
                    <div class="hidden md:flex items-center space-x-6">
                        <a href="#/" class="nav-link text-gray-600 dark:text-gray-300 hover:text-primary-DEFAULT dark:hover:text-primary-light px-3 py-2 rounded-md text-base font-medium transition-colors">Dashboard</a>
                        <a href="#/lancamentos" class="nav-link text-gray-600 dark:text-gray-300 hover:text-primary-DEFAULT dark:hover:text-primary-light px-3 py-2 rounded-md text-base font-medium transition-colors">Lançamentos</a>
                        <a href="#/investimentos" class="nav-link text-gray-600 dark:text-gray-300 hover:text-primary-DEFAULT dark:hover:text-primary-light px-3 py-2 rounded-md text-base font-medium transition-colors">Investimentos</a>
                        <a href="#/grupos" class="nav-link text-gray-600 dark:text-gray-300 hover:text-primary-DEFAULT dark:hover:text-primary-light px-3 py-2 rounded-md text-base font-medium transition-colors">Grupos</a>
                        <a href="#/historico" class="nav-link text-gray-600 dark:text-gray-300 hover:text-primary-DEFAULT dark:hover:text-primary-light px-3 py-2 rounded-md text-base font-medium transition-colors">Histórico</a>
                    </div>

                    <!-- Botão de Tema e Menu do Usuário -->
                    <div class="flex items-center">
                        <button id="theme-toggle-button-navbar" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-800 focus:ring-primary-DEFAULT mr-3">
                            <svg id="theme-icon-light-navbar" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-15.66l-.707.707M4.04 19.96l-.707.707M21 12h-1M4 12H3m15.66 8.66l-.707-.707M4.04 4.04l-.707-.707"/></svg>
                            <svg id="theme-icon-dark-navbar" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        </button>

                        <div class="relative">
                            <button type="button" id="user-menu-button" class="flex items-center max-w-xs bg-gray-100 dark:bg-gray-700 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-800 focus:ring-primary-DEFAULT" aria-expanded="false" aria-haspopup="true">
                                <span class="sr-only">Abrir menu do usuário</span>
                                <img id="user-avatar" class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/100x100/E2E8F0/A0AEC0?text=User" alt="User Avatar">
                            </button>
                            <div id="user-menu-dropdown" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-xl bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none hidden transform opacity-0 scale-95 transition ease-in-out duration-100" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button">
                                <div class="py-1" role="none">
                                    <div class="px-4 py-3">
                                        <p id="user-menu-name" class="text-sm font-semibold text-gray-800 dark:text-white">Nome do Usuário</p>
                                        <p id="user-menu-email" class="text-xs text-gray-500 dark:text-gray-400 truncate">email@example.com</p>
                                    </div>
                                    <hr class="border-gray-200 dark:border-gray-700">
                                    <a href="#/configuracoes" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-primary-DEFAULT dark:hover:text-primary-light" role="menuitem">Configurações</a>
                                    <button id="logout-button" class="block w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-700/30 hover:text-red-700 dark:hover:text-red-300" role="menuitem">
                                        Sair
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Botão Hambúrguer para Mobile -->
                    <div class="md:hidden flex items-center">
                         <button id="theme-toggle-button-mobile-navbar" class="p-2 rounded-full text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 dark:focus:ring-offset-gray-800 focus:ring-primary-DEFAULT mr-2">
                            <svg id="theme-icon-light-mobile-navbar" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m8.66-15.66l-.707.707M4.04 19.96l-.707.707M21 12h-1M4 12H3m15.66 8.66l-.707-.707M4.04 4.04l-.707-.707"/></svg>
                            <svg id="theme-icon-dark-mobile-navbar" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                        </button>
                        <button id="mobile-menu-button" type="button" class="p-2 inline-flex items-center justify-center rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-DEFAULT" aria-controls="mobile-menu" aria-expanded="false">
                            <span class="sr-only">Abrir menu principal</span>
                            <svg id="menu-open-icon" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                            <svg id="menu-close-icon" class="hidden h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Menu Mobile -->
            <div id="mobile-menu" class="md:hidden hidden bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="#/" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-primary-DEFAULT dark:hover:text-primary-light">Dashboard</a>
                    <a href="#/lancamentos" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-primary-DEFAULT dark:hover:text-primary-light">Lançamentos</a>
                    <a href="#/investimentos" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-primary-DEFAULT dark:hover:text-primary-light">Investimentos</a>
                    <a href="#/grupos" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-primary-DEFAULT dark:hover:text-primary-light">Grupos</a>
                    <a href="#/historico" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-primary-DEFAULT dark:hover:text-primary-light">Histórico</a>
                </div>
                 <div class="pt-4 pb-3 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex items-center px-5">
                        <div class="flex-shrink-0">
                            <img id="user-avatar-mobile" class="h-10 w-10 rounded-full object-cover" src="https://placehold.co/100x100/E2E8F0/A0AEC0?text=User" alt="">
                        </div>
                        <div class="ml-3">
                            <div id="user-name-mobile" class="text-base font-medium text-gray-800 dark:text-white">Nome do Usuário</div>
                            <div id="user-email-mobile" class="text-sm font-medium text-gray-500 dark:text-gray-400">email@example.com</div>
                        </div>
                    </div>
                    <div class="mt-3 px-2 space-y-1">
                        <a href="#/configuracoes" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:text-primary-DEFAULT dark:hover:text-primary-light">Configurações</a>
                        <button id="logout-button-mobile" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-700/30 hover:text-red-700 dark:hover:text-red-300">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <!-- NOVO: Template da Página de Lançamentos -->
    <template id="lancamentos-template">
        <div class="relative min-h-[calc(100vh-200px)]">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white">Lançamentos</h1>
                <!-- Filtros (ainda sem funcionalidade) -->
                <div class="hidden sm:flex items-center p-1 rounded-lg bg-gray-200 dark:bg-gray-700">
                    <button class="px-4 py-2 text-sm font-semibold rounded-md bg-white dark:bg-gray-800 text-primary-DEFAULT shadow">Pessoal</button>
                    <button class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300">Grupo</button>
                </div>
            </div>

            <!-- Filtro de Mês -->
            <div class="mb-4 flex items-center space-x-2">
                <label for="month-filter-select" class="text-sm font-medium text-gray-700 dark:text-gray-300">Filtrar por Mês:</label>
                <select id="month-filter-select" name="month-filter" class="block w-full max-w-xs pl-3 pr-10 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm">
                    <option value="all">Todos os Meses</option> 
                    <!-- Outras opções de meses serão populadas por JavaScript -->
                </select>
            </div>

            <!-- Gráficos para a Página de Lançamentos -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6">
                <div class="bg-white dark:bg-secondary p-6 rounded-xl shadow-xl">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Despesas por Categoria (Mês Selecionado)</h3>
                    <div class="h-80"><canvas id="lancamentos-expenses-pie-chart"></canvas></div>
                </div>
                <div class="bg-white dark:bg-secondary p-6 rounded-xl shadow-xl">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-200">Receitas vs Despesas (Mês Selecionado)</h3>
                     <div class="h-80"><canvas id="lancamentos-income-expenses-bar-chart"></canvas></div>
                </div>
            </section>

            <div id="lancamentos-list" class="space-y-4">
                <!-- A lista de lançamentos será injetada aqui pelo JavaScript -->
                 <p id="lancamentos-list-placeholder" class="text-center text-gray-500 dark:text-gray-400 py-16">
                    Nenhum lançamento encontrado.<br>
                    Clique no botão '+' para adicionar um.
                </p>
            </div>

            <!-- Botão Flutuante para Adicionar Lançamento -->
            <button id="add-lancamento-btn" class="fixed bottom-24 right-8 md:bottom-12 md:right-12 bg-primary-DEFAULT hover:bg-primary-hover text-white rounded-full p-4 shadow-lg transition-transform transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-DEFAULT">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </div>
    </template>

    <!-- NOVO: Template do Modal de Adicionar/Editar Lançamento -->
    <template id="lancamento-modal-template">
        <div class="bg-white dark:bg-secondary rounded-xl shadow-2xl p-8 w-full max-w-lg transform transition-all opacity-100 scale-100">
             <form id="lancamento-form">
                <input type="hidden" id="lancamento-id">
                <h3 id="lancamento-modal-title" class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Novo Lançamento</h3>
                
                <!-- Tipo: Receita ou Despesa -->
                <fieldset class="mb-4">
                    <legend class="sr-only">Tipo de lançamento</legend>
                    <div class="flex items-center justify-around bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
                        <label for="tipo-receita" class="w-full text-center">
                            <input type="radio" name="tipo-lancamento" id="tipo-receita" value="receita" class="sr-only" checked>
                            <span class="cursor-pointer block px-4 py-2 rounded-md text-sm font-semibold transition-colors text-gray-600 dark:text-gray-300">Receita</span>
                        </label>
                        <label for="tipo-despesa" class="w-full text-center">
                            <input type="radio" name="tipo-lancamento" id="tipo-despesa" value="despesa" class="sr-only">
                            <span class="cursor-pointer block px-4 py-2 rounded-md text-sm font-semibold transition-colors text-gray-600 dark:text-gray-300">Despesa</span>
                        </label>
                    </div>
                </fieldset>

                <!-- Valor -->
                <div class="mb-4">
                     <label for="lancamento-valor" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Valor</label>
                     <div class="relative mt-1">
                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                            <span class="text-gray-500 sm:text-sm">R$</span>
                        </div>
                        <input type="number" step="0.01" min="0" name="valor" id="lancamento-valor" required
                               class="block w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm">
                    </div>
                </div>

                <!-- Descrição -->
                <div class="mb-4">
                     <label for="lancamento-descricao" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descrição</label>
                     <input type="text" name="descricao" id="lancamento-descricao" required
                           class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm">
                </div>

                <!-- Categoria e Data -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="lancamento-categoria" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Categoria</label>
                        <select id="lancamento-categoria" name="categoria" required class="mt-1 block w-full pl-3 pr-10 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm">
                            <option>Alimentação</option>
                            <option>Transporte</option>
                            <option>Lazer</option>
                            <option>Moradia</option>
                            <option>Salário</option>
                            <option>Investimentos</option>
                            <option>Outros</option>
                        </select>
                    </div>
                    <div>
                        <label for="lancamento-data" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data</label>
                        <input type="date" name="data" id="lancamento-data" required class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm">
                    </div>
                </div>

                <div class="flex items-center justify-end space-x-4">
                     <button type="button" id="close-lancamento-modal" class="px-6 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">Cancelar</button>
                     <button type="submit" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-DEFAULT hover:bg-primary-hover">Salvar</button>
                </div>
            </form>
        </div>
    </template>

    <template id="404-template">
        <div class="flex flex-col items-center justify-center text-center h-[calc(100vh-200px)]">
            <svg class="w-32 h-32 text-primary-DEFAULT mb-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
            </svg>
            <h1 class="text-6xl font-extrabold text-gray-800 dark:text-white mb-4">404</h1>
            <p class="text-2xl font-medium text-gray-600 dark:text-gray-300 mb-8">Oops! Página não encontrada.</p>
            <p class="text-lg text-gray-500 dark:text-gray-400 mb-8">
                A página que você está procurando não existe ou foi movida.
            </p>
            <a href="#/"
               class="px-8 py-3 bg-primary-DEFAULT text-white text-lg font-semibold rounded-lg hover:bg-primary-hover transition-colors shadow-lg">
                Voltar para o Início
            </a>
        </div>
    </template>

     <template id="forgot-password-modal-template">
        <div class="bg-white dark:bg-secondary rounded-xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Esqueceu sua senha?</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Não se preocupe! Digite seu email abaixo e enviaremos um link para redefinir sua senha.</p>
            </div>
            <form id="forgot-password-form">
                <div>
                    <label for="forgot-email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                    <input id="forgot-email" name="email" type="email" autocomplete="email" required
                           class="mt-1 block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-primary-DEFAULT focus:border-primary-DEFAULT sm:text-sm text-gray-900 dark:text-white">
                </div>
                <div class="mt-6">
                    <button type="submit"
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-DEFAULT hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-DEFAULT transition-transform transform hover:scale-105">
                        Enviar Link de Redefinição
                    </button>
                </div>
            </form>
            <p id="forgot-message" class="text-sm text-center mt-4"></p>
            <button id="close-forgot-modal" class="mt-6 w-full text-sm text-gray-600 dark:text-gray-400 hover:underline">Voltar para Login</button>
        </div>
    </template>


    <!-- Firebase SDK -->
    <script type="module">
        // Importações do Firebase SDK - ATUALIZADO PARA 11.8.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            GoogleAuthProvider,
            signInWithPopup,
            sendPasswordResetEmail,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            collection,
            addDoc,
            query,
            where,
            onSnapshot,
            orderBy,
            limit,
            serverTimestamp,
            deleteDoc,
            updateDoc,
            writeBatch,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js"; // Analytics não usado por enquanto

        // Configuração do Firebase
        const userProvidedFirebaseConfig = { // Configuração fornecida pelo usuário
            apiKey: "AIzaSyBeJyVD0Os7WWpEiObShsYzE2qoNRV3PY0",
            authDomain: "gestao-finc-compartilhada.firebaseapp.com",
            projectId: "gestao-finc-compartilhada",
            storageBucket: "gestao-finc-compartilhada.appspot.com", // VERIFIQUE SE É .appspot.com OU .firebasestorage.app NO SEU CONSOLE FIREBASE
            messagingSenderId: "988873226213",
            appId: "1:988873226213:web:8cb05b07ba7c48e574e10c",
            measurementId: "G-WGWJJXRT71"
        };

        const firebaseConfigFromHostString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const appIdFromHostForPaths = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Para estrutura de caminhos do Firestore

        let activeFirebaseConfig;

        if (firebaseConfigFromHostString) {
            try {
                const parsedHostConfig = JSON.parse(firebaseConfigFromHostString);
                // Verifica se a API key do host NÃO é um placeholder óbvio
                if (parsedHostConfig.apiKey && !parsedHostConfig.apiKey.includes("YOUR_API_KEY") && !parsedHostConfig.apiKey.includes("AIzaSyYOUR_API_KEY")) {
                    activeFirebaseConfig = parsedHostConfig;
                    console.log("Usando configuração do Firebase fornecida pelo host (aparentemente válida).");
                } else {
                    console.warn("Configuração do Firebase do host parece usar placeholders ou é inválida. Usando configuração fornecida manualmente.");
                    activeFirebaseConfig = userProvidedFirebaseConfig;
                }
            } catch (e) {
                console.error("Erro ao parsear __firebase_config. Usando configuração fornecida manualmente. ERRO:", e);
                activeFirebaseConfig = userProvidedFirebaseConfig;
            }
        } else {
            console.log("Variável __firebase_config não definida. Usando configuração Firebase fornecida manualmente.");
            activeFirebaseConfig = userProvidedFirebaseConfig;
        }

        console.log("Configuração Firebase ATIVA SENDO USADA:", JSON.stringify(activeFirebaseConfig)); // DEBUG: Mostra qual config está ativa

        const app = initializeApp(activeFirebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        // O appId para os caminhos do Firestore deve ser o ID da aplicação no ambiente Canvas, se disponível.
        let appIdForFirestorePaths = appIdFromHostForPaths;
        if (appIdForFirestorePaths === 'default-app-id' && activeFirebaseConfig.appId && !activeFirebaseConfig.appId.includes("YOUR_APP_ID")) {
            appIdForFirestorePaths = activeFirebaseConfig.appId;
            console.log(`appIdForFirestorePaths era 'default-app-id', usando activeFirebaseConfig.appId para caminhos do Firestore: ${appIdForFirestorePaths}`);
        } else if (appIdForFirestorePaths === 'default-app-id'){
             console.warn("appIdForFirestorePaths é 'default-app-id' e não foi possível obter um appId válido da configuração Firebase. Os caminhos do Firestore podem estar incorretos, usando 'default-app-id'.");
        }
        console.log("App ID FINALMENTE usado para caminhos do Firestore:", appIdForFirestorePaths);


        // --- Variáveis Globais de Estado ---
        let currentUser = null; // Armazena o objeto do usuário logado
        let currentUserId = null; // Armazena o UID do usuário logado
        let unsubscribeListeners = []; // Array para guardar todas as funções de unsubscribe
        let expensesPieChartInstance = null; // Dashboard
        let incomeExpensesBarChartInstance = null; // Dashboard
        let lancamentosExpensesPieChartInstance = null; // Lancamentos Page
        let lancamentosIncomeExpensesBarChartInstance = null; // Lancamentos Page


        // --- Constantes e Helpers ---
        const APP_NAME = "FinançasApp";
        const appRoot = document.getElementById('app-root');
        const navbarContainer = document.getElementById('navbar-container');
        const initialLoader = document.getElementById('initial-loader');
        const userIdDisplay = document.getElementById('user-id-display');

        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContainer = document.getElementById('modal-container');

        function showModal(templateId, initFunction, modalData = {}) {
            const template = document.getElementById(templateId);
            if (template) {
                modalContainer.innerHTML = template.innerHTML;
                modalContainer.style.display = 'flex';
                modalBackdrop.style.display = 'block';
                // Delay para animação
                setTimeout(() => {
                    modalContainer.querySelector('div').classList.remove('opacity-0', 'scale-95');
                    modalBackdrop.classList.remove('opacity-0');
                }, 10);

                if (initFunction && typeof initFunction === 'function') {
                    initFunction(modalData); // Passa os dados para a função de inicialização
                }
            } else {
                console.error(`Template do modal ${templateId} não encontrado.`);
            }
        }

        function closeModal() {
            if (modalContainer.firstChild) {
                 modalContainer.querySelector('div').classList.add('opacity-0', 'scale-95');
            }
            modalBackdrop.classList.add('opacity-0');
            setTimeout(() => {
                modalContainer.innerHTML = '';
                modalContainer.style.display = 'none';
                modalBackdrop.style.display = 'none';
            }, 300); // Duração da transição
        }

        // --- Roteador Simples ---
        const routes = {
            '/': { templateId: 'dashboard-template', init: initDashboardPage, protected: true },
            '/login': { templateId: 'login-template', init: initLoginPage, publicOnly: true },
            '/register': { templateId: 'register-template', init: initRegisterPage, publicOnly: true },
            '/lancamentos': { templateId: 'lancamentos-template', init: initLancamentosPage, protected: true },
            // Adicionar outras rotas aqui:
            // '/investimentos': { templateId: 'investimentos-template', init: initInvestimentosPage, protected: true },
            // '/grupos': { templateId: 'grupos-template', init: initGruposPage, protected: true },
            // '/historico': { templateId: 'historico-template', init: initHistoricoPage, protected: true },
            // '/configuracoes': { templateId: 'configuracoes-template', init: initConfiguracoesPage, protected: true },
        };
        const defaultRoute = '/login';
        const protectedDefaultRoute = '/';
        const page404 = { templateId: '404-template', init: () => {} };

        function cleanupPageListeners() {
            unsubscribeListeners.forEach(unsubscribe => unsubscribe());
            unsubscribeListeners = [];
            console.log("Listeners de página desligados.");
        }

        async function navigateTo(path) {
            window.location.hash = path;
        }

        async function router() {
            cleanupPageListeners();

            initialLoader.style.display = 'flex'; // Mostrar loader
            appRoot.innerHTML = ''; // Limpar conteúdo anterior

            const path = window.location.hash.slice(1) || (currentUserId ? protectedDefaultRoute : defaultRoute);
            let routeConfig = routes[path] || page404;

            // Lógica de proteção de rotas
            if (routeConfig.protected && !currentUserId) {
                console.log("Rota protegida, usuário não logado. Redirecionando para login.");
                navigateTo('/login');
                initialLoader.style.display = 'none';
                return;
            }
            if (routeConfig.publicOnly && currentUserId) {
                console.log("Rota pública apenas, usuário logado. Redirecionando para dashboard.");
                navigateTo('/');
                initialLoader.style.display = 'none';
                return;
            }


            const template = document.getElementById(routeConfig.templateId);
            if (template) {
                appRoot.innerHTML = template.innerHTML;
                if (routeConfig.init && typeof routeConfig.init === 'function') {
                    try {
                        await routeConfig.init(); // Chamar a função de inicialização da página
                    } catch (error) {
                        console.error(`Erro ao inicializar a página ${path}:`, error);
                        appRoot.innerHTML = `<p class="text-red-500 text-center p-8">Erro ao carregar a página. Tente novamente.</p>`;
                    }
                }
                updateActiveNavLink(path);
            } else {
                console.error(`Template para a rota ${path} não encontrado.`);
                const t404 = document.getElementById(page404.templateId);
                if (t404) appRoot.innerHTML = t404.innerHTML;
            }
            initialLoader.style.display = 'none'; // Esconder loader
        }

        function updateActiveNavLink(currentPath) {
            const navLinks = document.querySelectorAll('.nav-link, .mobile-nav-link');
            navLinks.forEach(link => {
                const linkPath = link.getAttribute('href').slice(1); // Remove #
                if (linkPath === currentPath) {
                    link.classList.add('text-primary-DEFAULT', 'dark:text-primary-light', 'bg-primary-DEFAULT/10', 'font-semibold');
                    link.classList.remove('text-gray-600', 'dark:text-gray-300');
                } else {
                    link.classList.remove('text-primary-DEFAULT', 'dark:text-primary-light', 'bg-primary-DEFAULT/10', 'font-semibold');
                    link.classList.add('text-gray-600', 'dark:text-gray-300');
                }
            });
        }


        // --- Lógica de Autenticação ---
        function initLoginPage() {
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const goToRegisterButton = document.getElementById('go-to-register');
            const loginGoogleButton = document.getElementById('login-google');
            const forgotPasswordLink = document.getElementById('forgot-password-link');


            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    loginError.classList.add('hidden');
                    loginError.textContent = '';
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;
                    try {
                        const userCredential = await signInWithEmailAndPassword(auth, email, password);
                        console.log("Login bem-sucedido:", userCredential.user);
                        // O onAuthStateChanged vai lidar com o redirecionamento
                    } catch (error) {
                        console.error("Erro no login:", error);
                        loginError.textContent = getFirebaseErrorMessage(error);
                        loginError.classList.remove('hidden');
                    }
                });
            }

            if (goToRegisterButton) {
                goToRegisterButton.addEventListener('click', () => navigateTo('/register'));
            }

            if (loginGoogleButton) {
                loginGoogleButton.addEventListener('click', async () => {
                     loginError.classList.add('hidden');
                     loginError.textContent = '';
                    const provider = new GoogleAuthProvider();
                    try {
                        const result = await signInWithPopup(auth, provider);
                        const user = result.user;
                        console.log("Login com Google bem-sucedido:", user);
                        // Verificar se é um novo usuário para criar o documento no Firestore
                        const userDocRef = doc(db, `artifacts/${appIdForFirestorePaths}/users/${user.uid}/profile/${user.uid}`);
                        const userDoc = await getDoc(userDocRef);
                        if (!userDoc.exists()) {
                            await setDoc(userDocRef, {
                                uid: user.uid,
                                name: user.displayName,
                                email: user.email,
                                photoURL: user.photoURL,
                                createdAt: serverTimestamp(),
                                appId: appIdForFirestorePaths // Usar o ID da app para o caminho
                            });
                            console.log("Novo usuário do Google salvo no Firestore em:", userDocRef.path);
                        }
                    } catch (error) {
                        console.error("Erro no login com Google:", error);
                        loginError.textContent = getFirebaseErrorMessage(error);
                        loginError.classList.remove('hidden');
                    }
                });
            }

            if(forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showModal('forgot-password-modal-template', initForgotPasswordModal);
                });
            }
        }

        function initForgotPasswordModal() {
            const form = document.getElementById('forgot-password-form');
            const emailInput = document.getElementById('forgot-email');
            const messageEl = document.getElementById('forgot-message');
            const closeModalButton = document.getElementById('close-forgot-modal');

            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = emailInput.value;
                    messageEl.textContent = '';
                    messageEl.classList.remove('text-green-500', 'text-red-500');

                    try {
                        await sendPasswordResetEmail(auth, email);
                        messageEl.textContent = 'Email de redefinição enviado! Verifique sua caixa de entrada.';
                        messageEl.classList.add('text-green-500');
                        emailInput.value = ''; // Limpar o campo
                    } catch (error) {
                        console.error("Erro ao enviar email de redefinição:", error);
                        messageEl.textContent = getFirebaseErrorMessage(error);
                        messageEl.classList.add('text-red-500');
                    }
                });
            }
            if (closeModalButton) {
                closeModalButton.addEventListener('click', closeModal);
            }
        }


        function initRegisterPage() {
            const registerForm = document.getElementById('register-form');
            const registerError = document.getElementById('register-error');
            const goToLoginButton = document.getElementById('go-to-login');

            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    registerError.classList.add('hidden');
                    registerError.textContent = '';

                    const name = document.getElementById('register-name').value;
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    const confirmPassword = document.getElementById('register-confirm-password').value;

                    if (password !== confirmPassword) {
                        registerError.textContent = "As senhas não coincidem.";
                        registerError.classList.remove('hidden');
                        return;
                    }
                    if (password.length < 6) {
                        registerError.textContent = "A senha deve ter pelo menos 6 caracteres.";
                        registerError.classList.remove('hidden');
                        return;
                    }

                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        console.log("Usuário registrado:", user);

                        // Atualizar perfil do Firebase Auth com o nome
                        await updateProfile(user, { displayName: name });

                        // Salvar dados adicionais no Firestore
                        const userDocRef = doc(db, `artifacts/${appIdForFirestorePaths}/users/${user.uid}/profile/${user.uid}`);
                        await setDoc(userDocRef, {
                            uid: user.uid,
                            name: name,
                            email: user.email,
                            photoURL: user.photoURL, // Pode ser null inicialmente
                            createdAt: serverTimestamp(),
                            appId: appIdForFirestorePaths // Usar o ID da app para o caminho
                        });
                        console.log("Dados do usuário salvos no Firestore:", userDocRef.path);

                        // O onAuthStateChanged vai lidar com o redirecionamento
                    } catch (error) {
                        console.error("Erro no registro:", error);
                        registerError.textContent = getFirebaseErrorMessage(error);
                        registerError.classList.remove('hidden');
                    }
                });
            }
             if(goToLoginButton) {
                goToLoginButton.addEventListener('click', () => navigateTo('/login'));
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                console.log("Logout bem-sucedido.");
                // O onAuthStateChanged vai lidar com o redirecionamento e atualização da UI
            } catch (error) {
                console.error("Erro no logout:", error);
                alert("Erro ao sair. Tente novamente.");
            }
        }

        function getFirebaseErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'Formato de email inválido.';
                case 'auth/user-disabled':
                    return 'Este usuário foi desabilitado.';
                case 'auth/user-not-found':
                    return 'Usuário não encontrado.';
                case 'auth/wrong-password':
                    return 'Senha incorreta.';
                case 'auth/email-already-in-use':
                    return 'Este email já está em uso.';
                case 'auth/weak-password':
                    return 'A senha é muito fraca. Use pelo menos 6 caracteres.';
                case 'auth/requires-recent-login':
                    return 'Esta operação é sensível e requer autenticação recente. Faça login novamente antes de tentar novamente.';
                case 'auth/too-many-requests':
                    return 'Muitas tentativas de login. Tente novamente mais tarde.';
                case 'auth/network-request-failed':
                    return 'Falha na rede. Verifique sua conexão com a internet.';
                case 'auth/cancelled-popup-request':
                     return 'Solicitação de login pop-up cancelada ou bloqueada.';
                case 'auth/popup-closed-by-user':
                     return 'Janela de login fechada antes da conclusão.';
                default:
                    console.warn("Erro Firebase não mapeado:", error.code, error.message);
                    return 'Ocorreu um erro. Tente novamente.';
            }
        }


        // --- Lógica do Dashboard ---
        async function initDashboardPage() {
            if (!currentUserId) {
                navigateTo('/login');
                return;
            }

            const userNameEl = document.getElementById('user-name-dashboard');
            const userProfilePath = `artifacts/${appIdForFirestorePaths}/users/${currentUserId}/profile/${currentUserId}`;
            const userDocRef = doc(db, userProfilePath);
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    if (userNameEl) userNameEl.textContent = userData.name || currentUser.displayName || 'Usuário';
                } else {
                     if (userNameEl) userNameEl.textContent = currentUser.displayName || 'Usuário'; // Fallback
                }
            } catch (error) {
                 if (userNameEl) userNameEl.textContent = (currentUser.displayName || 'Usuário') + " (Erro)";
            }
            
            // Inicia o listener de lançamentos para o dashboard
            listenForLancamentosDashboard();
        }

        function listenForLancamentosDashboard() {
            if (!currentUserId) return;

            // *** MUDANÇA: Usando a coleção principal 'lancamentos' ***
            const q = query(collection(db, 'lancamentos'), where("userId", "==", currentUserId), orderBy('data', 'desc'), limit(5));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const lancamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDashboardUI(lancamentos);
            }, (error) => {
                console.error("Erro ao ouvir lançamentos para o dashboard:", error);
                 if (error.code === 'permission-denied') {
                    console.error("!!!! ERRO DE PERMISSÃO DO FIRESTORE NO DASHBOARD!!!! Verifique suas Regras de Segurança para a coleção 'lancamentos'.");
                }
            });
            unsubscribeListeners.push(unsubscribe); // Armazena a função para desligar o listener
        }

        function updateDashboardUI(lancamentos) {
            let totalReceitas = 0;
            let totalDespesas = 0;
            const despesasPorCategoria = {};

            lancamentos.forEach(lanc => {
                if (lanc.tipo === 'receita') {
                    totalReceitas += lanc.valor;
                } else {
                    totalDespesas += lanc.valor;
                    despesasPorCategoria[lanc.categoria] = (despesasPorCategoria[lanc.categoria] || 0) + lanc.valor;
                }
            });

            const saldo = totalReceitas - totalDespesas;

            document.getElementById('dashboard-total-receitas').textContent = `R$ ${totalReceitas.toFixed(2)}`;
            document.getElementById('dashboard-total-despesas').textContent = `R$ ${totalDespesas.toFixed(2)}`;
            document.getElementById('dashboard-saldo-atual').textContent = `R$ ${saldo.toFixed(2)}`;
            
            if (typeof Chart !== 'undefined') {
                // This function is for the dashboard, ensure it targets dashboard instances
                updateDashboardCharts(despesasPorCategoria, totalReceitas, totalDespesas);
            }

            const recentListEl = document.getElementById('recent-lancamentos-list');
            if(recentListEl){
                renderLancamentosList(lancamentos, recentListEl); 
            }
        }

        function updateDashboardCharts(despesasPorCategoria, totalReceitas, totalDespesas) {
            // Specific to Dashboard Pie Chart
            if(expensesPieChartInstance) {
                expensesPieChartInstance.data.labels = Object.keys(despesasPorCategoria);
                expensesPieChartInstance.data.datasets[0].data = Object.values(despesasPorCategoria);
                expensesPieChartInstance.update();
            }

            // Specific to Dashboard Bar Chart (if it were to show monthly summary, it would need different data)
            // For now, the dashboard bar chart is static or updated elsewhere.
            // If it's meant to show current month's income vs expense like the lancamentos page,
            // it would need totalReceitas and totalDespesas for the current month.
            // Example if dashboard bar chart needs to be updated with current month totals:
            /*
            if(incomeExpensesBarChartInstance) {
                const currentMonthLabel = new Date().toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                incomeExpensesBarChartInstance.data.labels = [currentMonthLabel];
                incomeExpensesBarChartInstance.data.datasets[0].data = [totalReceitas];
                incomeExpensesBarChartInstance.data.datasets[1].data = [totalDespesas];
                incomeExpensesBarChartInstance.update();
            }
            */
        }

        function updateCharts(despesasPorCategoria) { // This seems to be a duplicate or old name
            const labels = Object.keys(despesasPorCategoria);
            const data = Object.values(despesasPorCategoria);

            if(expensesPieChartInstance){ // Assumes this is for dashboard
                expensesPieChartInstance.data.labels = labels;
                expensesPieChartInstance.data.datasets[0].data = data;
                expensesPieChartInstance.update();
            }
        }


        // --- Lógica da Página de Lançamentos ---
        async function initLancamentosPage() {
            if (!currentUserId) {
                navigateTo('/login');
                return;
            }

            initLancamentosCharts(); // Initialize charts for the Lancamentos page

            const addBtn = document.getElementById('add-lancamento-btn');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    showModal('lancamento-modal-template', initLancamentoModal);
                });
            }

            const monthFilterSelect = document.getElementById('month-filter-select');

            // 1. Fetch all lancamentos for the user ONCE to populate the filter
            // Using a separate query with getDocs for one-time fetch
            const allUserLancamentosQuery = query(
                collection(db, "lancamentos"), 
                where("userId", "==", currentUserId), 
                orderBy("data", "desc")
            );
            try {
                const querySnapshot = await getDocs(allUserLancamentosQuery);
                const allLancamentos = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateMonthFilter(allLancamentos, monthFilterSelect);
            } catch (error) {
                console.error("Erro ao buscar todos os lançamentos para o filtro de mês:", error);
                populateMonthFilter([], monthFilterSelect); // Popula com default em caso de erro
            }
            
            // 2. Add event listener to the month filter
            if (monthFilterSelect) {
                monthFilterSelect.addEventListener('change', () => {
                    const selectedMonth = monthFilterSelect.value;
                    // O 'pessoal' é mantido por enquanto, pode ser um tipo de filtro diferente
                    listenForLancamentos('pessoal', selectedMonth); 
                });
            }

            // 3. Initial call to listenForLancamentos
            const initialMonthToLoad = monthFilterSelect ? monthFilterSelect.value : "all";
            listenForLancamentos('pessoal', initialMonthToLoad);


            // Adicionar event listener para botões de editar e remover (event delegation)
            const lancamentosListEl = document.getElementById('lancamentos-list');
            if (lancamentosListEl) {
                lancamentosListEl.addEventListener('click', async (event) => {
                    const editButton = event.target.closest('.edit-lancamento-btn');
                    const removeButton = event.target.closest('.remove-lancamento-btn');

                    if (editButton) {
                        const lancamentoId = editButton.dataset.id;
                        if (!lancamentoId) {
                            console.error("ID do lançamento não encontrado no botão de editar.");
                            return;
                        }
                        
                        console.log(`Tentando editar lançamento com ID: ${lancamentoId}`);
                        const docRef = doc(db, 'lancamentos', lancamentoId);
                        try {
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                const lancamentoData = docSnap.data();
                                console.log("Dados do lançamento para edição:", lancamentoData);
                                showModal('lancamento-modal-template', initLancamentoModal, { id: lancamentoId, ...lancamentoData });
                            } else {
                                console.error("Nenhum documento encontrado para editar com ID:", lancamentoId);
                                alert("Erro: Lançamento não encontrado para edição.");
                            }
                        } catch (error) {
                            console.error("Erro ao buscar lançamento para edição:", error);
                            alert("Erro ao carregar dados do lançamento para edição.");
                        }
                    } else if (removeButton) {
                        const lancamentoId = removeButton.dataset.id;
                        if (!lancamentoId) {
                            console.error("ID do lançamento não encontrado no botão de remover.");
                            return;
                        }
                        await handleDeleteLancamento(lancamentoId);
                    }
                });
            }
        }

        function formatMonthYear(dateString) { // dateString in "YYYY-MM"
            const [year, monthNum] = dateString.split('-');
            const date = new Date(year, monthNum - 1);
            return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        }

        function populateMonthFilter(lancamentos, selectElement) {
            if (!selectElement) return;

            const uniqueMonths = new Set();
            lancamentos.forEach(lanc => {
                if (lanc.data && lanc.data.seconds) {
                    const date = new Date(lanc.data.seconds * 1000);
                    const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    uniqueMonths.add(monthYear);
                }
            });

            const sortedMonths = Array.from(uniqueMonths).sort((a, b) => b.localeCompare(a)); // Descending

            selectElement.innerHTML = ''; // Clear existing options

            const allMonthsOption = document.createElement('option');
            allMonthsOption.value = "all";
            allMonthsOption.textContent = "Todos os Meses";
            selectElement.appendChild(allMonthsOption);

            sortedMonths.forEach(monthYear => {
                const option = document.createElement('option');
                option.value = monthYear;
                option.textContent = formatMonthYear(monthYear);
                selectElement.appendChild(option);
            });
        }

        async function handleDeleteLancamento(lancamentoId) {
            if (!currentUserId || !lancamentoId) {
                console.error("Usuário não logado ou ID do lançamento não fornecido para remoção.");
                return;
            }

            const confirmDelete = confirm("Tem certeza que deseja remover este lançamento?");
            if (confirmDelete) {
                try {
                    const docRef = doc(db, 'lancamentos', lancamentoId);
                    await deleteDoc(docRef);
                    console.log("Lançamento removido com sucesso, ID:", lancamentoId);
                } catch (error) {
                    console.error("Erro ao remover lançamento:", error);
                    alert("Erro ao remover lançamento. Tente novamente.");
                }
            }
        }

        function listenForLancamentos(filterType, selectedMonth = "all") {
            if (!currentUserId) return;
            
            const listEl = document.getElementById('lancamentos-list');
            if (!listEl) {
                console.error("Elemento da lista de lançamentos não encontrado.");
                return;
            }

            let q;
            if (selectedMonth && selectedMonth !== "all") {
                const [year, month] = selectedMonth.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 1); // Primeiro dia do próximo mês

                q = query(collection(db, "lancamentos"),
                          where("userId", "==", currentUserId),
                          where("data", ">=", Timestamp.fromDate(startDate)),
                          where("data", "<", Timestamp.fromDate(endDate)),
                          orderBy("data", "desc"));
            } else {
                // Query padrão para buscar todos os lançamentos do usuário
                q = query(collection(db, "lancamentos"), 
                          where("userId", "==", currentUserId), 
                          orderBy("data", "desc"));
            }

            // Limpar listeners antigos antes de adicionar um novo para evitar duplicação
            // Isso é importante se listenForLancamentos puder ser chamado múltiplas vezes com diferentes filtros
            const currentUnsubscribe = unsubscribeListeners.find(item => item.id === 'lancamentosListener');
            if (currentUnsubscribe && typeof currentUnsubscribe.func === 'function') {
                currentUnsubscribe.func(); // Chamar a função de unsubscribe
                unsubscribeListeners = unsubscribeListeners.filter(item => item.id !== 'lancamentosListener'); // Remover da lista
                 console.log("Listener de lançamentos anterior desligado.");
            }


            const unsubscribe = onSnapshot(q, (snapshot) => {
                const lancamentos = snapshot.docs.map(docData => ({ id: docData.id, ...docData.data() }));
                renderLancamentosList(lancamentos, listEl);
                updateLancamentosCharts(lancamentos, selectedMonth); // Atualiza os gráficos com os dados filtrados
            }, (error) => {
                console.error(`Erro ao buscar lançamentos (${filterType}, Mês: ${selectedMonth}):`, error);
                if (listEl) listEl.innerHTML = `<p class="text-center text-red-500 py-16">Erro ao carregar lançamentos. Verifique o console.</p>`;
            });
            unsubscribeListeners.push({id: 'lancamentosListener', func: unsubscribe}); 
            console.log("Novo listener de lançamentos ativado para o mês:", selectedMonth);
        }

        function initLancamentosCharts() {
            if (typeof Chart === 'undefined') { 
                console.warn("Chart.js não carregado, pulando inicialização dos gráficos de lançamentos.");
                return; 
            }
        
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#CBD5E1' : '#4A5568'; // slate-300 para dark, gray-700 para light
            const gridColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

            // Pie Chart for Lancamentos Expenses
            const pieCtx = document.getElementById('lancamentos-expenses-pie-chart')?.getContext('2d');
            if (pieCtx) {
                if (lancamentosExpensesPieChartInstance) lancamentosExpensesPieChartInstance.destroy();
                lancamentosExpensesPieChartInstance = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['rgba(239, 68, 68, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(234, 179, 8, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(217, 70, 239, 0.7)'], borderColor: isDarkMode ? '#1F2937' : '#FFFFFF', borderWidth: 2 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor, padding: 15, font: { size: 12 } } }, tooltip: { bodyFont: { size: 12 }, titleFont: { size: 14, weight: 'bold' } } } }
                });
            } else {
                console.warn("Canvas 'lancamentos-expenses-pie-chart' não encontrado.");
            }
        
            // Bar Chart for Lancamentos Income vs Expenses
            const barCtx = document.getElementById('lancamentos-income-expenses-bar-chart')?.getContext('2d');
            if (barCtx) {
                if (lancamentosIncomeExpensesBarChartInstance) lancamentosIncomeExpensesBarChartInstance.destroy();
                lancamentosIncomeExpensesBarChartInstance = new Chart(barCtx, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Receitas', data: [], backgroundColor: 'rgba(16, 185, 129, 0.7)', borderRadius: 4 }, { label: 'Despesas', data: [], backgroundColor: 'rgba(239, 68, 68, 0.7)', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: textColor, font: { size: 12 } }, grid: { color: gridColor } }, x: { ticks: { color: textColor, font: { size: 12 } }, grid: { display: false } } }, plugins: { legend: { position: 'top', labels: { color: textColor, font: { size: 14 } } }, tooltip: { bodyFont: { size: 12 }, titleFont: { size: 14, weight: 'bold' } } } }
                });
            } else {
                 console.warn("Canvas 'lancamentos-income-expenses-bar-chart' não encontrado.");
            }
            console.log("Gráficos da página de lançamentos inicializados/re-inicializados.");
        }

        function updateLancamentosCharts(filteredLancamentos, selectedMonth) {
            if (!lancamentosExpensesPieChartInstance || !lancamentosIncomeExpensesBarChartInstance) {
                console.warn("Instâncias dos gráficos de lançamentos não encontradas. Pulando atualização.");
                return;
            }

            let totalReceitas = 0;
            let totalDespesas = 0;
            const despesasPorCategoria = {};

            filteredLancamentos.forEach(lanc => {
                if (lanc.tipo === 'receita') {
                    totalReceitas += lanc.valor;
                } else {
                    totalDespesas += lanc.valor;
                    despesasPorCategoria[lanc.categoria] = (despesasPorCategoria[lanc.categoria] || 0) + lanc.valor;
                }
            });

            // Update Pie Chart
            lancamentosExpensesPieChartInstance.data.labels = Object.keys(despesasPorCategoria);
            lancamentosExpensesPieChartInstance.data.datasets[0].data = Object.values(despesasPorCategoria);
            lancamentosExpensesPieChartInstance.update();

            // Update Bar Chart
            const monthLabel = selectedMonth === "all" ? "Total Geral" : (formatMonthYear(selectedMonth) || selectedMonth);
            lancamentosIncomeExpensesBarChartInstance.data.labels = [monthLabel];
            lancamentosIncomeExpensesBarChartInstance.data.datasets[0].data = [totalReceitas]; // Receitas
            lancamentosIncomeExpensesBarChartInstance.data.datasets[1].data = [totalDespesas]; // Despesas
            lancamentosIncomeExpensesBarChartInstance.update();
             console.log("Gráficos da página de lançamentos atualizados para o mês:", selectedMonth);
        }
        
        function renderLancamentosList(lancamentos, containerEl) {
             const placeholder = document.getElementById('lancamentos-list-placeholder');
            if (!containerEl) return;
            
            containerEl.innerHTML = ''; // Limpa a lista
            if(lancamentos.length === 0){
                if (placeholder) placeholder.style.display = 'block';
                 containerEl.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400 py-16">Nenhum lançamento encontrado.<br>Clique no botão '+' para adicionar um.</p>`;
                return;
            }
            if (placeholder) placeholder.style.display = 'none';

            lancamentos.forEach(lanc => {
                const isReceita = lanc.tipo === 'receita';
                const valorCor = isReceita ? 'text-green-500' : 'text-red-500';
                const dataFormatada = lanc.data ? new Date(lanc.data.seconds * 1000).toLocaleDateString('pt-BR') : 'Data inválida';

                const itemHTML = `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md flex items-center justify-between space-x-4">
                        <div class="flex items-center space-x-4">
                            <span class="p-3 rounded-full ${isReceita ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'}">
                                <svg class="${isReceita ? 'text-green-600 dark:text-green-300' : 'text-red-600 dark:text-red-300'} w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                     ${isReceita ? '<path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />' : '<path stroke-linecap="round" stroke-linejoin="round" d="M18 12H6" />'}
                                </svg>
                            </span>
                            <div>
                                <p class="font-bold text-gray-800 dark:text-gray-100">${lanc.descricao}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${lanc.categoria} &bull; ${dataFormatada}</p>
                            </div>
                        </div>
                        <div class="text-right">
                           <p class="font-bold text-lg ${valorCor}">
                                ${isReceita ? '+' : '-'} R$ ${lanc.valor.toFixed(2)}
                           </p>
                           <div class="mt-2">
                                <button data-id="${lanc.id}" class="edit-lancamento-btn px-3 py-1 text-xs font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-md shadow-sm">Editar</button>
                                <button data-id="${lanc.id}" class="remove-lancamento-btn px-3 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded-md shadow-sm ml-2">Remover</button>
                            </div>
                        </div>
                    </div>
                `;
                containerEl.innerHTML += itemHTML;
            });
        }


        function initLancamentoModal(data = {}) {
            const form = document.getElementById('lancamento-form');
            const title = document.getElementById('lancamento-modal-title');
            const idInput = document.getElementById('lancamento-id');
            const valorInput = document.getElementById('lancamento-valor');
            const descricaoInput = document.getElementById('lancamento-descricao');
            const categoriaInput = document.getElementById('lancamento-categoria');
            const dataInput = document.getElementById('lancamento-data');
            const receitaRadio = document.getElementById('tipo-receita');
            const despesaRadio = document.getElementById('tipo-despesa');
            
            const tipoLabels = document.querySelectorAll('input[name="tipo-lancamento"] + span');
            function updateTipoStyle() {
                tipoLabels.forEach(label => {
                    const radio = document.getElementById(label.parentElement.htmlFor);
                    if (radio.checked) {
                        label.classList.add('bg-white', 'dark:bg-gray-900', 'text-primary-DEFAULT');
                        label.classList.remove('text-gray-600', 'dark:text-gray-300');
                    } else {
                        label.classList.remove('bg-white', 'dark:bg-gray-900', 'text-primary-DEFAULT');
                        label.classList.add('text-gray-600', 'dark:text-gray-300');
                    }
                });
            }
            receitaRadio.addEventListener('change', updateTipoStyle);
            despesaRadio.addEventListener('change', updateTipoStyle);
            updateTipoStyle();
            
            if (data.id) {
                title.textContent = "Editar Lançamento";
                idInput.value = data.id;
                valorInput.value = data.valor;
                descricaoInput.value = data.descricao;
                categoriaInput.value = data.categoria;
                dataInput.value = new Date(data.data.seconds * 1000).toISOString().split('T')[0];
                if (data.tipo === 'receita') receitaRadio.checked = true;
                else despesaRadio.checked = true;
                updateTipoStyle();
            } else {
                dataInput.value = new Date().toISOString().split('T')[0];
            }

            document.getElementById('close-lancamento-modal').addEventListener('click', closeModal);
            form.onsubmit = async (e) => {
                e.preventDefault();
                if(!currentUserId) return;

                const lancamentoData = {
                    valor: parseFloat(valorInput.value),
                    descricao: descricaoInput.value,
                    categoria: categoriaInput.value,
                    data: Timestamp.fromDate(new Date(dataInput.value + 'T00:00:00')),
                    tipo: receitaRadio.checked ? 'receita' : 'despesa',
                    userId: currentUserId,
                    // appId não é mais necessário aqui com a nova estrutura
                };

                // *** MUDANÇA: Usando a coleção principal 'lancamentos' ***
                const lancamentosCollectionRef = collection(db, 'lancamentos');

                try {
                    if (idInput.value) { // Atualizar existente
                        const docRef = doc(lancamentosCollectionRef, idInput.value);
                        await updateDoc(docRef, lancamentoData);
                        console.log("Lançamento atualizado com ID: ", idInput.value);
                    } else { // Criar novo
                        lancamentoData.createdAt = serverTimestamp();
                        const docRef = await addDoc(lancamentosCollectionRef, lancamentoData);
                        console.log("Lançamento salvo com ID: ", docRef.id);
                    }
                    closeModal();
                } catch(error) {
                    console.error("Detailed error saving lancamento: ", error);
                    alert("Erro ao salvar. Verifique o console para mais detalhes. Código: " + error.code);
                }
            };
        }


        // --- Funções Auxiliares de UI ---
        function initCharts() {
            if (typeof Chart === 'undefined') { return; }
        
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#CBD5E1' : '#4A5568';
            const gridColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
        
            const expensesCtx = document.getElementById('expenses-pie-chart')?.getContext('2d');
            if (expensesCtx) {
                if (expensesPieChartInstance) expensesPieChartInstance.destroy();
                expensesPieChartInstance = new Chart(expensesCtx, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: ['rgba(239, 68, 68, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(139, 92, 246, 0.7)'], borderColor: isDarkMode ? '#1F2937' : '#FFFFFF', borderWidth: 2 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor, padding: 20, font: { size: 14 } } }, tooltip: { bodyFont: { size: 14 }, titleFont: { size: 16, weight: 'bold' } } } }
                });
            }
        
            const incomeExpensesCtx = document.getElementById('income-expenses-bar-chart')?.getContext('2d');
            if (incomeExpensesCtx) {
                if (incomeExpensesBarChartInstance) incomeExpensesBarChartInstance.destroy();
                incomeExpensesBarChartInstance = new Chart(incomeExpensesCtx, {
                    type: 'bar',
                    data: { labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'], datasets: [{ label: 'Receitas', data: [], backgroundColor: 'rgba(16, 185, 129, 0.7)', borderRadius: 4 }, { label: 'Despesas', data: [], backgroundColor: 'rgba(239, 68, 68, 0.7)', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: textColor, font: { size: 12 } }, grid: { color: gridColor } }, x: { ticks: { color: textColor, font: { size: 12 } }, grid: { display: false } } }, plugins: { legend: { position: 'top', labels: { color: textColor, font: { size: 14 } } }, tooltip: { bodyFont: { size: 14 }, titleFont: { size: 16, weight: 'bold' } } } }
                });
            }
        }
        
        function updateNavbarUI(user) {
            const loggedInTemplate = document.getElementById('navbar-template-logged-in');
            const loggedOutTemplate = document.getElementById('navbar-template-logged-out');

            if (user) {
                if (loggedInTemplate) {
                    navbarContainer.innerHTML = loggedInTemplate.innerHTML;
                    document.getElementById('logout-button')?.addEventListener('click', handleLogout);
                    document.getElementById('logout-button-mobile')?.addEventListener('click', handleLogout);

                    const userAvatar = document.getElementById('user-avatar');
                    const userAvatarMobile = document.getElementById('user-avatar-mobile');
                    const userNameMenu = document.getElementById('user-menu-name');
                    const userEmailMenu = document.getElementById('user-menu-email');
                    const userNameMobile = document.getElementById('user-name-mobile');
                    const userEmailMobile = document.getElementById('user-email-mobile');

                    if (user.photoURL) {
                        if (userAvatar) userAvatar.src = user.photoURL;
                        if (userAvatarMobile) userAvatarMobile.src = user.photoURL;
                    } else {
                         const placeholderAvatar = "https://placehold.co/100x100/E2E8F0/A0AEC0?text=" + (user.displayName ? user.displayName.charAt(0).toUpperCase() : "U");
                         if (userAvatar) userAvatar.src = placeholderAvatar;
                         if (userAvatarMobile) userAvatarMobile.src = placeholderAvatar;
                    }
                    if (userNameMenu) userNameMenu.textContent = user.displayName || 'Usuário';
                    if (userEmailMenu) userEmailMenu.textContent = user.email;
                    if (userNameMobile) userNameMobile.textContent = user.displayName || 'Usuário';
                    if (userEmailMobile) userEmailMobile.textContent = user.email;


                    // Menu Dropdown do Usuário
                    const userMenuButton = document.getElementById('user-menu-button');
                    const userMenuDropdown = document.getElementById('user-menu-dropdown');
                    if(userMenuButton && userMenuDropdown) {
                        userMenuButton.addEventListener('click', (e) => {
                            e.stopPropagation(); // Evitar que o clique feche imediatamente o menu
                            const isExpanded = userMenuButton.getAttribute('aria-expanded') === 'true' || false;
                            userMenuButton.setAttribute('aria-expanded', !isExpanded);
                            userMenuDropdown.classList.toggle('hidden');
                            userMenuDropdown.classList.toggle('opacity-0');
                            userMenuDropdown.classList.toggle('scale-95');
                            userMenuDropdown.classList.toggle('opacity-100');
                            userMenuDropdown.classList.toggle('scale-100');
                        });
                    }

                    // Menu Mobile
                    const mobileMenuButton = document.getElementById('mobile-menu-button');
                    const mobileMenu = document.getElementById('mobile-menu');
                    const menuOpenIcon = document.getElementById('menu-open-icon');
                    const menuCloseIcon = document.getElementById('menu-close-icon');

                    if (mobileMenuButton && mobileMenu && menuOpenIcon && menuCloseIcon) {
                        mobileMenuButton.addEventListener('click', () => {
                            const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true' || false;
                            mobileMenuButton.setAttribute('aria-expanded', !isExpanded);
                            mobileMenu.classList.toggle('hidden');
                            menuOpenIcon.classList.toggle('hidden');
                            menuCloseIcon.classList.toggle('hidden');
                        });
                    }
                     // Fechar menu mobile ao clicar em um link
                    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
                    mobileNavLinks.forEach(link => {
                        link.addEventListener('click', () => {
                            if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
                                mobileMenuButton.click(); // Simula clique para fechar
                            }
                        });
                    });

                }
            } else {
                if (loggedOutTemplate) {
                    navbarContainer.innerHTML = loggedOutTemplate.innerHTML;
                }
            }
             // Adicionar listeners para os botões de tema DEPOIS que a navbar for renderizada
            setupThemeToggle('theme-toggle-button-navbar', 'theme-icon-light-navbar', 'theme-icon-dark-navbar');
            setupThemeToggle('theme-toggle-button-mobile-navbar', 'theme-icon-light-mobile-navbar', 'theme-icon-dark-mobile-navbar');
        }
        // Fechar dropdowns se clicar fora
        document.addEventListener('click', (event) => {
            const userMenuButton = document.getElementById('user-menu-button');
            const userMenuDropdown = document.getElementById('user-menu-dropdown');
            if (userMenuButton && userMenuDropdown && !userMenuButton.contains(event.target) && !userMenuDropdown.contains(event.target) && !userMenuDropdown.classList.contains('hidden')) {
                userMenuButton.setAttribute('aria-expanded', 'false');
                userMenuDropdown.classList.add('hidden', 'opacity-0', 'scale-95');
                userMenuDropdown.classList.remove('opacity-100', 'scale-100');
            }
        });


        // Sistema de Tema (Claro/Escuro)
        function getInitialTheme() {
            try {
                if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    return 'dark';
                }
            } catch (e) {
                console.warn("Não foi possível acessar localStorage para o tema. Usando tema claro como padrão. Erro:", e);
            }
            return 'light';
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateAllThemeIcons();
            
            const currentPage = window.location.hash.slice(1) || (currentUserId ? protectedDefaultRoute : defaultRoute);
            if (typeof Chart !== 'undefined') {
                // A small delay can help ensure the DOM is ready for chart rendering/re-rendering
                setTimeout(() => {
                    if (currentPage === '/' || currentPage === '') { // Dashboard
                        initCharts(); 
                    } else if (currentPage === '/lancamentos') { // Lancamentos page
                        initLancamentosCharts();
                    }
                }, 50);
            } else {
                console.warn("Chart não definido ao tentar redesenhar para o tema.");
            }
        }


        function setupThemeToggle(buttonId, lightIconId, darkIconId) {
            const themeToggleButton = document.getElementById(buttonId);
            const lightIcon = document.getElementById(lightIconId);
            const darkIcon = document.getElementById(darkIconId);

            if (!themeToggleButton || !lightIcon || !darkIcon) return;

            themeToggleButton.addEventListener('click', () => {
                let currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                try {
                    localStorage.theme = newTheme;
                } catch (e) {
                    console.warn("Não foi possível salvar o tema no localStorage. Erro:", e);
                }
                applyTheme(newTheme);
            });
        }

        function updateAllThemeIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            const allLightIcons = document.querySelectorAll('[id^="theme-icon-light"]');
            const allDarkIcons = document.querySelectorAll('[id^="theme-icon-dark"]');

            allLightIcons.forEach(icon => icon.classList.toggle('hidden', isDark));
            allDarkIcons.forEach(icon => icon.classList.toggle('hidden', !isDark));
        }

        // Aplica o tema no carregamento inicial
        applyTheme(getInitialTheme());


        // --- Listener de Autenticação do Firebase ---
        onAuthStateChanged(auth, async (user) => {
            console.log("Estado de autenticação mudou. Usuário:", user ? user.uid : "Nenhum");
            currentUser = user; // Atualiza o usuário global
            currentUserId = user ? user.uid : null;

            if (userIdDisplay) {
                userIdDisplay.textContent = currentUserId || "Não conectado";
            }

            updateNavbarUI(user); // Atualiza a barra de navegação
            await router(); // Chama o roteador para carregar a página correta
        });


        // --- Inicialização da Aplicação ---
        window.addEventListener('hashchange', router);
        // O onAuthStateChanged vai chamar o router na carga inicial, após verificar o estado de auth.

        console.log("App de Finanças Inicializado. Aguardando estado de autenticação...");

    </script>
</body>
</html>